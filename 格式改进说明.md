# ChatGPT 导出格式改进说明

## 问题分析

### 原始问题
根据你提供的两张图片对比：

**图1（Kelivo 中的显示）：**
- 格式简单，只有纯文本
- 没有保留粗体、列表等格式
- 使用 `> user:` 和 `> assistant:` 作为分隔符

**图2（ChatGPT 原始格式）：**
- 保留了完整的 Markdown 格式
- 有粗体（`**文本**`）
- 有列表（`•` 和编号列表）
- 有清晰的层次结构

### 根本原因
旧版插件使用 `innerText` 提取内容，这会**丢失所有 HTML 格式**：
```javascript
// 旧代码
content = markdownEl.innerText.trim();  // ❌ 丢失所有格式
```

## 解决方案

### 核心改进
1. **HTML 转 Markdown 转换器**
   - 遍历 DOM 树，识别 HTML 元素
   - 将每个元素转换为对应的 Markdown 语法
   - 保留嵌套结构和格式

2. **支持的格式**
   - ✅ 粗体：`<strong>` → `**text**`
   - ✅ 斜体：`<em>` → `*text*`
   - ✅ 行内代码：`<code>` → `` `code` ``
   - ✅ 代码块：`<pre><code>` → ` ```language\ncode\n``` `
   - ✅ 标题：`<h1>` - `<h6>` → `#` - `######`
   - ✅ 列表：`<ul>/<ol>` → `•` / `1.`
   - ✅ 引用：`<blockquote>` → `> text`
   - ✅ 链接：`<a>` → `[text](url)`
   - ✅ 图片：`<img>` → `![alt](src)`
   - ✅ 表格：`<table>` → Markdown 表格
   - ✅ 水平线：`<hr>` → `---`

3. **改进的输出格式（符合 Kelivo 导入要求）**
   ```markdown
   # 对话标题

   > 用户

   用户的第一条消息...

   > 助手

   助手的回复...

   > 用户

   用户的第二条消息...

   > 助手

   助手的第二次回复...
   ```

   **格式特点：**
   - ✅ 使用 `> 用户` 和 `> 助手` 标记角色（Kelivo 导入格式要求）
   - ✅ 保留完整的 Markdown 格式（粗体、列表、代码块等）
   - ✅ 每条消息之间用空行分隔
   - ✅ 符合 Kelivo 的 `import_markdown.dart` 解析规则

### 技术实现

#### 1. HTML 转 Markdown 函数
```javascript
function htmlToMarkdown(element) {
    // 递归遍历 DOM 树
    // 识别每个元素的类型
    // 转换为对应的 Markdown 语法
}
```

#### 2. 智能内容提取
```javascript
// 新代码
let contentElement = element.querySelector('.markdown');
content = htmlToMarkdown(contentElement);  // ✅ 保留所有格式
```

#### 3. 格式清理
- 自动移除按钮、工具栏等噪音元素
- 清理多余的空行
- 保留有意义的空白和缩进

## 效果对比

### 旧版输出
```markdown
> user:
更赚钱的活动几乎都和平台自有玩法/平台币挂钩

> assistant:
可以，但要讲清楚件事：
(1) 更赚钱的活动几乎都和平台自有玩法/平台币挂钩
(2) 150-300U 的小预算，适合批"低成本参与、能量化ROI"的活动
```

### 新版输出
```markdown
> 用户

**更赚钱**的活动几乎都和平台自有玩法/平台币挂钩

> 助手

可以，但要讲清楚件事：

**（1）"更赚钱"的活动几乎都和平台自有玩法/平台币挂钩；**回报更高、门槛/不确定性也更高。

**（2）150-300U 的小预算，适合批"低成本参与、能量化ROI"的活动**，而不是去卷手续费很重的交易竞赛。

### 一句话建议（150-300U 档位）

• **优先试：MEXC Kickstarter（投票空投）+ Bybit Launchpool / Airdrop Arcade（质押/任务空投）**
  这两类对小资金更友好：**门槛清晰、成本可控**，不用天天高频交易；但**收益依活动而变，不保证**。

• **次优选：KuCoin Spotlight（IEO/申购）**
  落在收益更"集中"，但通常要持**KCS或按净资产规则参与**，承受平台币价格波动；且平台当前有合规整改背景，需自评可接受度。

> 用户

下一条消息...
```

**改进点：**
- ✅ 使用 `> 用户` 和 `> 助手` 标记角色（符合 Kelivo 导入格式）
- ✅ 保留完整的 Markdown 格式（粗体、列表、代码块等）
- ✅ 每条消息之间用空行分隔
- ✅ 导入到 Kelivo 后格式不会乱

## 使用说明

### 安装更新
1. 替换 `browser-extension/content.js` 文件
2. 在浏览器扩展管理页面重新加载扩展
3. 刷新 ChatGPT 页面

### 测试
1. 打开一个包含丰富格式的 ChatGPT 对话
2. 点击"导出到 Kelivo"按钮
3. 在 Kelivo 中查看导出的对话
4. 验证格式是否完整保留

### 注意事项
- 确保 ChatGPT 页面已完全加载
- 对于长对话，等待自动滚动完成
- 如果格式仍有问题，请检查浏览器控制台的日志

## 兼容性

- ✅ Chrome/Edge（Chromium 内核）
- ✅ ChatGPT 网页版（2024-2025 版本）
- ✅ Kelivo 应用（支持 Markdown 渲染）

## 后续优化建议

1. **支持更多格式**
   - 数学公式（LaTeX）
   - 脚注
   - 任务列表（`- [ ]`）

2. **性能优化**
   - 缓存转换结果
   - 异步处理大型对话

3. **用户自定义**
   - 允许用户选择输出格式
   - 支持自定义分隔符
   - 支持导出为其他格式（JSON、HTML 等）

