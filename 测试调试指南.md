# 测试和调试指南

## 如何测试扩展

### 1. 重新加载扩展

1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 找到 "ChatGPT to Kelivo Exporter" 扩展
4. 点击 "重新加载" 按钮（🔄图标）

### 2. 打开 ChatGPT 对话

1. 访问 https://chat.openai.com/
2. 打开一个包含丰富格式的对话（包含列表、代码块、粗体等）
3. 按 F12 打开浏览器开发者工具
4. 切换到 "Console"（控制台）标签页

### 3. 导出对话

1. 点击页面上的 "导出到 Kelivo" 按钮
2. 等待导出完成
3. 查看控制台输出的调试信息

## 调试信息说明

### 消息提取日志

```
消息 1: 角色=user, roleAttr=user
  找到 markdown 容器，子元素数量: 5
  内容元素 HTML 预览: <div class="markdown">...</div>
  === 开始转换 HTML 为 Markdown (消息 1) ===
  克隆后的元素子节点数量: 10
  克隆后的元素子元素数量: 5
  移除元素: BUTTON - copy-button
    处理 ul 元素，listLevel=0, 子节点数=10
    处理 li 元素，listLevel=0, 子节点数=3
  === 转换完成，Markdown 长度: 1234 ===
  Markdown 预览:
  ### 标题
  • 列表项 1
  • 列表项 2
  ...
```

### 关键信息

1. **子元素数量**：如果数量很少，可能是容器选择不正确
2. **处理 ul/li 元素**：查看是否所有列表项都被处理
3. **Markdown 长度**：如果长度明显偏小，说明内容丢失
4. **Markdown 预览**：直接查看转换后的内容

## 常见问题排查

### 问题1：列表项丢失

**症状**：
- 原始对话有 5 个列表项
- 导出后只有 2 个列表项

**排查步骤**：
1. 查看控制台日志中 "处理 li 元素" 的数量
2. 如果数量正确，说明是转换逻辑问题
3. 如果数量不对，说明是容器选择或 DOM 结构问题

**可能原因**：
- 列表项在不同的容器中
- 某些列表项被过滤掉了
- HTML 结构特殊，没有被正确识别

### 问题2：格式丢失

**症状**：
- 原始对话有粗体、代码块等格式
- 导出后变成纯文本

**排查步骤**：
1. 查看 Markdown 预览中是否有 `**粗体**`、` ```代码块``` ` 等标记
2. 如果没有，说明 HTML 转 Markdown 逻辑有问题

**可能原因**：
- `getTextContent` 函数没有正确处理格式标签
- 某些 HTML 标签没有对应的处理逻辑

### 问题3：内容重复或混乱

**症状**：
- 导出的内容有重复
- 顺序混乱

**排查步骤**：
1. 查看 "消息 X: 角色=..." 的日志数量
2. 检查是否有重复的消息被提取

**可能原因**：
- 消息选择器匹配了多个元素
- DOM 结构变化，选择器失效

## 手动检查 HTML 结构

### 1. 在 ChatGPT 页面打开开发者工具

1. 按 F12
2. 切换到 "Elements"（元素）标签页

### 2. 检查消息容器

1. 点击开发者工具左上角的选择器图标（🔍）
2. 在页面上点击一条消息
3. 查看右侧的 HTML 结构

### 3. 关键信息

- **消息容器**：通常是 `<div data-message-author-role="user">` 或 `<div data-message-author-role="assistant">`
- **内容容器**：通常是 `<div class="markdown">` 或 `<div class="prose">`
- **列表结构**：查看 `<ul>` 和 `<li>` 的嵌套关系

### 4. 对比选择器

检查 `content.js` 中的选择器是否匹配实际的 HTML 结构：

```javascript
// 消息选择器（第 176 行）
const messageElements = document.querySelectorAll('[data-message-author-role]');

// 内容选择器（第 216-247 行）
const markdownEl = element.querySelector('.markdown, [class*="markdown"]');
const proseEl = element.querySelector('[class*="prose"]');
const preWrapEl = element.querySelector('.whitespace-pre-wrap');
```

## 提交问题报告

如果问题仍然存在，请提供以下信息：

1. **浏览器版本**：Chrome 版本号
2. **扩展版本**：v1.2.0
3. **问题描述**：详细描述问题现象
4. **控制台日志**：复制完整的控制台输出
5. **HTML 结构**：复制消息容器的 HTML（右键 → Copy → Copy outerHTML）
6. **截图**：原始对话和导出结果的对比截图

## 临时解决方案

如果导出的内容不完整，可以：

1. **手动补充**：在 Kelivo 中编辑导入的对话，补充丢失的内容
2. **使用纯文本**：暂时使用 `innerText` 提取（修改 `content.js` 第 265-276 行）
3. **分段导出**：将长对话分成多个部分导出

## 反馈渠道

- GitHub Issues: [项目地址]
- Email: [联系邮箱]

